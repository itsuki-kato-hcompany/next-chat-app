# チャットルームへの参加・取得のGraphql設計

## 機能要件

1. チャットルームの作成
2. ログインユーザーが参加していないチャットルームへの参加
3. ログインユーザーが参加していないチャットルームへの招待（即時追加）
4. ログインユーザーが参加しているチャットルームの一覧表示
5. ログインユーザーが参加していないチャットルームの一覧表示

---

## DB設計

- 既存の設計と変更なし

```prisma
model User {
  id             Int       @id @default(autoincrement())
  name           String
  email          String    @unique
  password       String?
  profileImgPath String?   @map("profile_img_path")
  deletedAt      DateTime? @map("deleted_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // --- Relations ---
  refreshTokens   RefreshToken[]
  oauthAccounts   OAuthAccount[]
  channels        ChannelUser[]
  messages        Message[]
  messageReads    MessageRead[]
  createdChannels Channel[]      @relation("CreatedChannels")
  updatedChannels Channel[]      @relation("UpdatedChannels")

  @@map("users")
}

model Channel {
  id        Int       @id @default(autoincrement())
  name      String
  isArchive Boolean   @default(false) @map("is_archive")
  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // --- Relations ---
  creatorId Int           @map("create_user_id")
  creator   User          @relation("CreatedChannels", fields: [creatorId], references: [id])
  updaterId Int           @map("update_user_id")
  updater   User          @relation("UpdatedChannels", fields: [updaterId], references: [id])
  users     ChannelUser[]
  messages  Message[]

  @@map("channels")
}

model ChannelRole {
  id        String   @id @default(cuid())
  name      String   @unique
  sortNo    Int      @map("sort_no")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // --- Relations ---
  users ChannelUser[]

  @@map("channel_roles")
}

// 中間テーブル: UserとChannelの多対多関係 + role
model ChannelUser {
  id        Int       @id @default(autoincrement())
  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // --- Relations ---
  userId    Int         @map("user_id")
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  channelId Int         @map("channel_id")
  channel   Channel     @relation(fields: [channelId], references: [id], onDelete: Cascade)
  roleId    String      @map("role_id")
  role      ChannelRole @relation(fields: [roleId], references: [id])

  @@unique([userId, channelId])
  @@map("channel_users")
}
```

## GraphQL設計

### Query

```graphql
type Query {
  # 参加中のチャンネル一覧
  myChannels: [Channel!]!

  # 未参加のチャンネル一覧
  availableChannels: [Channel!]!
}
```

### Mutation

```graphql
type Mutation {
  # チャンネル作成
  createChannel(input: CreateChannelInput!): Channel!

  # チャンネル参加（自分）
  # デフォルトのRoleは一般ユーザーにする（後からチャンネルオーナーのみ変更可能）
  joinChannel(input: JoinChannelInput!): Channel!

  # チャンネル招待（他のユーザーを追加）
  # デフォルトのRoleは一般ユーザーにする（後からチャンネルオーナーのみ変更可能）
  inviteToChannel(input: InviteToChannelInput!): Channel!
}

input CreateChannelInput {
  name: String!
}

# 自分からチャンネルに参加する用
input JoinChannelInput {
  channelId: Int!
  userId: Int!
}

# チャンネルに招待する用（複数ユーザーに対応する）
input InviteToChannelInput {
  channelId: Int!
  userIds: [IntID!]!
}
```